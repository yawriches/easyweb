<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - My Easy Web Income</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    .btn-save {
      background-color: #4CAF50;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }
    .btn-save:hover {
      background-color: #45a049;
    }
    .status-message {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
      display: block;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
      display: block;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>Admin Dashboard</h1>
    <p>Update the button links below. Changes will be saved automatically.</p>
    
    <div class="form-group">
      <label for="primaryUrl">Primary Button (Get Started) URL:</label>
      <input type="url" id="primaryUrl" placeholder="https://example.com/primary">
    </div>
    
    <div class="form-group">
      <label for="secondaryUrl">Secondary Button (Learn More) URL:</label>
      <input type="url" id="secondaryUrl" placeholder="https://example.com/secondary">
    </div>
    
    <div class="form-group">
      <label for="accentUrl">Accent Button (Join Now) URL:</label>
      <input type="url" id="accentUrl" placeholder="https://example.com/accent">
    </div>
    
    <button id="saveBtn" class="btn-save">Save Changes</button>
    <div id="statusMessage" class="status-message"></div>
  </div>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize the button manager
        window.buttonManager = new ButtonManager();
        
        // Load saved data
        await loadButtonData();
        
        // Setup form submission
        document.getElementById('saveBtn').addEventListener('click', saveButtonData);
      } catch (error) {
        console.error('Error initializing admin page:', error);
        showStatus('Failed to initialize admin page', 'error');
      }
    });
    
    async function loadButtonData() {
      try {
        // Try to load from SheetDB with the sheet parameter
        const response = await fetch('https://sheetdb.io/api/v1/ixretu8my1aw8?sheet=Sheet1');
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const rows = await response.json();
        if (!rows || !rows.length) {
          console.log('No data found in SheetDB');
          return;
        }
        
        // Update form with the first row of data
        const row = rows[0];
        console.log('Raw data from SheetDB:', row);
        
        // Set the values from the row data
        if (row.btn1 !== undefined) document.getElementById('primaryUrl').value = row.btn1;
        if (row.btn2 !== undefined) document.getElementById('secondaryUrl').value = row.btn2;
        if (row.btn3 !== undefined) document.getElementById('accentUrl').value = row.btn3;
        
        console.log('Loaded button data:', {
          primaryUrl: row.btn1,
          secondaryUrl: row.btn2,
          accentUrl: row.btn3
        });
      } catch (error) {
        console.error('Error loading button data:', error);
        showStatus('Failed to load button data', 'error');
      }
    }
    
    async function saveButtonData() {
      const saveBtn = document.getElementById('saveBtn');
      const statusEl = document.getElementById('statusMessage');
      
      try {
        // Disable save button during save
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        statusEl.className = 'status-message';
        
        // Get form values
        const primaryUrl = document.getElementById('primaryUrl').value.trim();
        const secondaryUrl = document.getElementById('secondaryUrl').value.trim();
        const accentUrl = document.getElementById('accentUrl').value.trim();
        
        // First, try to get the current data to check the structure
        const getResponse = await fetch('https://sheetdb.io/api/v1/ixretu8my1aw8?sheet=Sheet1');
        if (getResponse.ok) {
          const existingData = await getResponse.json();
          console.log('Existing data:', existingData);
          
          // If we have existing data, delete it first
          if (existingData && existingData.length > 0) {
            const deleteResponse = await fetch('https://sheetdb.io/api/v1/ixretu8my1aw8/all?sheet=Sheet1', {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            if (!deleteResponse.ok) {
              const error = await deleteResponse.text();
              console.error('Delete error:', error);
              throw new Error('Failed to clear existing data: ' + error);
            }
            console.log('Successfully cleared existing data');
          }
        }
        
        // Prepare the new data in the same format as button1
        const payload = {
          data: [{
            btn1: primaryUrl || '',
            btn2: secondaryUrl || '',
            btn3: accentUrl || ''
          }]
        };
        
        console.log('Saving new data:', payload);
        
        // Send new data to SheetDB using POST
        const response = await fetch('https://sheetdb.io/api/v1/ixretu8my1aw8?sheet=Sheet1', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        const responseData = await response.json();
        console.log('Save response:', responseData);
        
        if (!response.ok) {
          throw new Error(`Failed to save: ${JSON.stringify(responseData)}`);
        }
        
        // Show success message
        showStatus('Changes saved successfully!', 'success');
        
      } catch (error) {
        console.error('Error saving button data:', error);
        showStatus(`Error: ${error.message}`, 'error');
      } finally {
        // Re-enable save button
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }
    
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusEl.className = 'status-message';
      }, 5000);
    }
  </script>
</body>
</html>
